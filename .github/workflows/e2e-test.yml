name: E2E Tests

on:
  push:
    branches:
      - main
      - develop
  pull_request:
    branches:
      - main
      - develop
  workflow_dispatch:

jobs:
  e2e-tests:
    name: ZecKit E2E Test Suite
    runs-on: ubuntu-latest

    timeout-minutes: 60

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Setup Docker
        run: |
          echo "━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━"
          echo "  Setting up Docker"
          echo "━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━"

          # Ensure Docker is running and accessible
          sudo systemctl start docker || true
          sudo usermod -aG docker $USER || true

          echo "Waiting for Docker daemon..."
          for i in {1..30}; do
            if docker ps > /dev/null 2>&1; then
              echo "✓ Docker daemon is ready!"
              break
            fi
            echo "Attempt $i/30: Docker not ready yet, waiting..."
            sleep 2
          done

          docker --version
          docker compose version
          echo ""

      - name: Run ZecKit E2E Tests
        id: e2e
        uses: ./.github/actions/zeckit-e2e
        with:
          backend: 'zaino'
          timeout: '45'
          chain-params: 'regtest'

      - name: Upload test logs
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: e2e-logs-zaino-${{ github.run_number }}
          path: |
            status.log
            zebra.log
            backend.log
            zingo.log
          retention-days: 7

      - name: Test summary
        if: always()
        run: |
          echo ""
          echo "━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━"
          echo "  E2E Test Execution Summary"
          echo "━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━"
          echo ""

          if [ "${{ steps.e2e.outputs.test-results }}" = '{"status":"passed"}' ]; then
            echo "✓ Status: ALL TESTS PASSED ✓"
            echo ""
            echo "Completed checks:"
            echo "  ✓ Docker environment ready"
            echo "  ✓ ZecKit CLI built"
            echo "  ✓ Devnet started with zaino backend"
            echo "  ✓ Golden E2E flow completed:"
            echo "    - UA generation"
            echo "    - Address funding"
            echo "    - Autoshielding"
            echo "    - Shielded transaction"
            echo "    - Wallet rescan/sync"
            echo "    - Balance verification"
            echo ""
            echo "The ZecKit devnet is working correctly!"
          else
            echo "✗ Status: TESTS FAILED ✗"
            echo ""
            echo "Check the uploaded artifacts for detailed logs:"
            echo "Artifact: e2e-logs-zaino-${{ github.run_number }}"
            echo ""
            echo "Common troubleshooting:"
            echo "1. Check zebra.log for node startup issues"
            echo "2. Check backend.log for zaino connectivity problems"
            echo "3. Check zingo.log for wallet operation failures"
            echo "4. Check status.log for overall test status"
          fi

          echo ""
          echo "━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━"
          echo ""
